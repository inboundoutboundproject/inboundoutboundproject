<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NU International Exchange System</title>
    
    <!-- Preconnect to external domains for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://script.google.com">
    
    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="style.css" as="style">
    <link rel="preload" href="script.js" as="script">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body class="min-h-screen bg-gradient-to-br from-gray-50 via-gray-100 to-gray-200">
    <div id="nav-container"></div>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Hero -->
        <div class="text-center mb-12 md:mb-16 slide-in">
            <div class="floating mb-8 md:mb-12 relative">
                <div class="inline-block p-6 md:p-10 rounded-full text-white shadow-2xl relative overflow-hidden">
                    <img class="w-32 h-32 sm:w-28 sm:h-28 md:w-64 md:h-64" src="2015_color.png" alt="2015_color.png">
                </div>
            </div>
            <h1 class="text-4xl sm:text-5xl md:text-7xl lg:text-8xl font-extrabold gradient-text mb-6">
                NU International Exchange
            </h1>
        </div>

        <!-- Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 max-w-6xl mx-auto mb-12 md:mb-16">
            <div class="feature-card hover-scale cursor-pointer" onclick="navigateToEntry()">
                <div class="absolute inset-0 bg-gradient-to-br from-red-500/5 to-red-700/10 rounded-3xl"></div>
                <div class="relative z-10 p-6 md:p-10">
                    <div
                        class="w-16 h-16 md:w-20 md:h-20 mx-auto bg-gradient-to-br from-red-500 to-red-700 rounded-2xl flex items-center justify-center shadow-lg mb-4 md:mb-6">
                        <i data-lucide="users" class="w-8 h-8 md:w-10 md:h-10 text-white"></i>
                    </div>
                    <h3 class="text-2xl md:text-3xl font-bold mb-3 md:mb-4">Exchange Student Registration</h3>
                    <p class="text-base md:text-lg text-gray-600">Register for exchange programs</p>
                    <div class="mt-4 md:mt-6 text-red-600 flex items-center justify-center font-semibold">
                        Get Started <i data-lucide="arrow-right" class="ml-2 w-4 h-4 md:w-5 md:h-5"></i>
                    </div>
                </div>
            </div>

            <div class="feature-card hover-scale cursor-pointer" onclick="navigateToView()">
                <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-blue-700/10 rounded-3xl"></div>
                <div class="relative z-10 p-6 md:p-10">
                    <div
                        class="w-16 h-16 md:w-20 md:h-20 mx-auto bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl flex items-center justify-center shadow-lg mb-4 md:mb-6">
                        <i data-lucide="bar-chart-3" class="w-8 h-8 md:w-10 md:h-10 text-white"></i>
                    </div>
                    <h3 class="text-2xl md:text-3xl font-bold mb-3 md:mb-4">Data Management</h3>
                    <p class="text-base md:text-lg text-gray-600">View and manage student exchange records</p>
                    <div class="mt-4 md:mt-6 text-blue-600 flex items-center justify-center font-semibold">
                        View Records <i data-lucide="arrow-right" class="ml-2 w-4 h-4 md:w-5 md:h-5"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl p-8 md:p-12 border border-white/20">
            <h2 class="text-3xl md:text-4xl font-bold text-center mb-8 md:mb-12">Exchange Program</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-8 text-center">
                <div>
                    <div class="text-5xl md:text-6xl font-extrabold gradient-counter mb-2 md:mb-3" id="total-students">0
                    </div>
                    <p class="text-base md:text-lg text-gray-600">Total Students</p>
                </div>
                <div>
                    <div class="text-5xl md:text-6xl font-extrabold gradient-counter mb-2 md:mb-3" id="countries">0
                    </div>
                    <p class="text-base md:text-lg text-gray-600">Partner Countries</p>
                </div>
                <div>
                    <div class="text-5xl md:text-6xl font-extrabold gradient-counter mb-2 md:mb-3" id="universities">0
                    </div>
                    <p class="text-base md:text-lg text-gray-600">Partner Universities</p>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="bg-gradient-to-br from-white via-gray-50 to-white rounded-3xl shadow-2xl p-8 md:p-10 border border-gray-200/50 mt-12 backdrop-blur-sm">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 md:mb-10">
                <h2 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent" style="font-family: 'Poppins', sans-serif;">Exchange Program Overview</h2>
                <select id="filterType"
                    class="mt-4 md:mt-0 px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500 text-sm md:text-base font-medium transition-all duration-300 hover:border-red-400 bg-white shadow-sm" style="font-family: 'Poppins', sans-serif;">
                    <option value="">All (Inbound + Outbound)</option>
                    <option value="inbound">Inbound Only</option>
                    <option value="outbound">Outbound Only</option>
                </select>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-10">
                <!-- Chart 1 - Pie Chart -->
                <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-lg border border-gray-200 p-6 md:p-8 hover:shadow-2xl hover:scale-[1.02] transition-all duration-300 flex flex-col items-center">
                    <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 text-center" style="font-family: 'Poppins', sans-serif;">
                        Inbound vs Outbound
                    </h3>
                    <div class="relative w-56 h-56 sm:w-64 sm:h-64 md:w-80 md:h-80">
                        <canvas id="programTypeChart"></canvas>
                    </div>
                </div>

                <!-- Chart 2 - Bar Chart -->
                <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-lg border border-gray-200 p-6 md:p-8 hover:shadow-2xl hover:scale-[1.02] transition-all duration-300 flex flex-col items-center">
                    <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 text-center" style="font-family: 'Poppins', sans-serif;">
                        Students by Country
                    </h3>
                    <div class="relative w-full h-72 md:h-80 lg:h-96">
                        <canvas id="countryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Year-based Charts Section (Separate) -->
        <div class="bg-gradient-to-br from-white via-gray-50 to-white rounded-3xl shadow-2xl p-8 md:p-10 border border-gray-200/50 mt-12 backdrop-blur-sm">
            <!-- Header + Filters -->
            <div class="flex flex-col md:flex-row md:items-start md:justify-between mb-8 md:mb-10 gap-6">
                <h2 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent" style="font-family: 'Poppins', sans-serif;">Travel Year Analysis</h2>

                <div class="flex flex-col gap-4">
                    <!-- Type filter -->
                    <div class="flex items-center gap-3">
                        <label class="text-sm font-semibold text-gray-600" style="font-family: 'Poppins', sans-serif;">Program Type:</label>
                        <select id="yearFilterType"
                            class="px-4 py-2 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500 text-sm font-medium bg-white shadow-sm transition-all hover:border-red-400" style="font-family: 'Poppins', sans-serif;"
                            onchange="applyYearFilters()">
                            <option value="">All (Inbound + Outbound)</option>
                            <option value="inbound">Inbound Only</option>
                            <option value="outbound">Outbound Only</option>
                        </select>
                    </div>

                    <!-- Year select (populated dynamically) -->
                    <div class="flex items-center gap-3">
                        <label class="text-sm font-semibold text-gray-600" style="font-family: 'Poppins', sans-serif;">Year:</label>
                        <select id="yearSelectFilter"
                            class="px-4 py-2 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500 text-sm font-medium bg-white shadow-sm transition-all hover:border-red-400" style="font-family: 'Poppins', sans-serif;"
                            onchange="applyYearFilters()">
                            <option value="">All Years</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-10">
                <!-- Chart 3 - Students by Year -->
                <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-lg border border-gray-200 p-6 md:p-8 hover:shadow-2xl hover:scale-[1.02] transition-all duration-300 flex flex-col items-center">
                    <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 text-center" style="font-family: 'Poppins', sans-serif;">
                        Students by Destination
                    </h3>
                    <div class="relative w-full h-72 md:h-80 lg:h-96">
                        <canvas id="yearChart"></canvas>
                    </div>
                </div>

                <!-- Chart 4 - Inbound vs Outbound per Year -->
                <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-lg border border-gray-200 p-6 md:p-8 hover:shadow-2xl hover:scale-[1.02] transition-all duration-300 flex flex-col items-center">
                    <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 text-center" style="font-family: 'Poppins', sans-serif;">
                        Inbound vs Outbound by Year
                    </h3>
                    <div class="relative w-full h-72 md:h-80 lg:h-96">
                        <canvas id="yearTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        function navigateToEntry() { window.location.href = 'entry.html'; }
        function navigateToView() { window.location.href = 'view.html'; }

        let programTypeChart, countryChart, yearChart, yearTypeChart;
        let cachedData = null; // Store data to avoid multiple API calls

        document.addEventListener('DOMContentLoaded', async () => {
            loadNavigation();
            lucide.createIcons();

            // Show skeleton loading
            showSkeletonLoading(true);

            // Load data with timeout to prevent indefinite loading
            try {
                // Add timeout promise
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Loading timeout')), 10000)
                );
                
                cachedData = await Promise.race([
                    ExchangeDataManager.loadData(),
                    timeoutPromise
                ]);
                
                // Hide skeleton and show actual data
                showSkeletonLoading(false);
                
                // Use cached data for all initial renders
                loadStatistics();
                renderPieChart();
                renderBarChart();
                renderYearChart();
                renderYearTypeChart();
                buildYearCheckboxes();
            } catch (error) {
                console.error('Error loading data:', error);
                showSkeletonLoading(false);
                // Show error message to user
                document.getElementById('total-students').textContent = 'Error';
            }

            const filterSelect = document.getElementById('filterType');
            filterSelect.addEventListener('change', e => {
                renderBarChart(e.target.value);
                loadStatistics(e.target.value);
            });
        });

        function showSkeletonLoading(show) {
            const statsElements = ['total-students', 'countries', 'universities'];
            statsElements.forEach(id => {
                const el = document.getElementById(id);
                if (show) {
                    el.classList.add('skeleton');
                    el.textContent = '000';
                } else {
                    el.classList.remove('skeleton');
                }
            });
        }

        function loadStatistics(filter = "") {
            // Use cached data instead of loading again
            const data = filter ? cachedData.filter(d => d.formType === filter) : cachedData;

            animateCounter('total-students', data.length);
            animateCounter('countries', new Set(data.map(d => d.country)).size);
            animateCounter('universities', new Set(data.map(d => d.university)).size);
        }


        function animateCounter(id, target) {
            let el = document.getElementById(id), n = 0, step = target / 25; // Faster
            let timer = setInterval(() => {
                n += step;
                if (n >= target) { n = target; clearInterval(timer); }
                el.textContent = Math.floor(n);
            }, 20); // Faster interval
        }

        function renderPieChart() {
            // Use cached data
            if (programTypeChart) programTypeChart.destroy();

            const inbound = cachedData.filter(d => d.formType === 'inbound').length;
            const outbound = cachedData.filter(d => d.formType === 'outbound').length;

            programTypeChart = new Chart(document.getElementById('programTypeChart'), {
                type: 'pie',  // Changed from 'doughnut' to 'pie' for full circle
                data: {
                    labels: ['Inbound', 'Outbound'],
                    datasets: [{
                        data: [inbound, outbound],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.9)',   // Modern green
                            'rgba(59, 130, 246, 0.9)'   // Modern blue
                        ],
                        borderWidth: 2,  // Thin black border for decoration
                        borderColor: '#000000',  // Black border
                        hoverBackgroundColor: [
                            'rgba(34, 197, 94, 1)',
                            'rgba(59, 130, 246, 1)'
                        ],
                        hoverBorderWidth: 3,  // Slightly thicker on hover
                        hoverBorderColor: '#000000',  // Black border on hover
                        hoverOffset: 15  // Makes the slice pop out on hover
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#1f2937',
                                font: { 
                                    size: 14, 
                                    weight: '600',
                                    family: "'Poppins', sans-serif"
                                },
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: {
                                size: 14,
                                weight: '600',
                                family: "'Poppins', sans-serif"
                            },
                            bodyFont: {
                                size: 13,
                                family: "'Poppins', sans-serif"
                            },
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return ` ${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeInOutCubic'
                    }
                }
            });
        }
        function renderBarChart(filter = "") {
            // Use cached data
            const data = filter ? cachedData.filter(d => d.formType === filter) : cachedData;
            if (countryChart) countryChart.destroy();

            const countryCounts = {};
            data.forEach(d => {
                if (d.country) countryCounts[d.country] = (countryCounts[d.country] || 0) + 1;
            });

            // Modern gradient colors
            const gradientColors = [
                { start: '#ef4444', end: '#dc2626' },  // Red
                { start: '#3b82f6', end: '#2563eb' },  // Blue
                { start: '#10b981', end: '#059669' },  // Green
                { start: '#8b5cf6', end: '#7c3aed' },  // Purple
                { start: '#f59e0b', end: '#d97706' },  // Amber
                { start: '#06b6d4', end: '#0891b2' },  // Cyan
                { start: '#ec4899', end: '#db2777' },  // Pink
                { start: '#14b8a6', end: '#0d9488' },  // Teal
                { start: '#f97316', end: '#ea580c' },  // Orange
                { start: '#6366f1', end: '#4f46e5' }   // Indigo
            ];

            const ctx = document.getElementById('countryChart').getContext('2d');
            const barBackgrounds = Object.keys(countryCounts).map((_, i) => {
                const colorPair = gradientColors[i % gradientColors.length];
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, colorPair.start);
                gradient.addColorStop(1, colorPair.end);
                return gradient;
            });

            // Transform data to ensure minimum visible height
            const transformedData = Object.values(countryCounts).map(value => {
                // If value is very small (1-3), add a small offset for visibility
                return value > 0 && value < 3 ? value + 2 : value;
            });

            countryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(countryCounts),
                    datasets: [{
                        label: 'Students',
                        data: transformedData,  // Use transformed data
                        backgroundColor: barBackgrounds,
                        borderColor: '#000000',  // Black border for bars
                        borderWidth: 2,  // Border thickness
                        borderRadius: 8,
                        borderSkipped: false,
                        barPercentage: 0.7,
                        categoryPercentage: 0.8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: {
                                size: 14,
                                weight: '600',
                                family: "'Poppins', sans-serif"
                            },
                            bodyFont: {
                                size: 13,
                                family: "'Poppins', sans-serif"
                            },
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    // Get original value from countryCounts
                                    const country = context.label;
                                    const originalValue = countryCounts[country];
                                    return ` ${originalValue} student${originalValue !== 1 ? 's' : ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 100,  // Set max to make smaller values more visible
                            ticks: { 
                                color: '#1f2937',
                                font: { 
                                    size: 16,  // Even larger font
                                    weight: '700',  // Bolder
                                    family: "'Poppins', sans-serif"
                                },
                                padding: 12,
                                stepSize: 10  // Smaller steps to show more detail
                            },
                            grid: { 
                                color: 'rgba(0, 0, 0, 0.05)',  // Very light grid lines
                                lineWidth: 1,
                                drawBorder: true,
                                borderColor: '#000000',
                                borderWidth: 2
                            },
                            border: {
                                display: true,
                                color: '#000000',
                                width: 2
                            }
                        },
                        x: {
                            ticks: { 
                                color: '#1f2937',
                                font: { 
                                    size: 12,  // Good readable size
                                    weight: '600',
                                    family: "'Poppins', sans-serif"
                                },
                                padding: 12,
                                maxRotation: 45,  // 45 degree angle
                                minRotation: 45,  // 45 degree angle
                                autoSkip: false  // Show all labels
                            },
                            grid: { 
                                display: false 
                            },
                            border: {
                                display: true,
                                color: '#000000',
                                width: 2
                            }
                        }
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeInOutCubic'
                    }
                }
            });
        }

        // Build year options in select — from 2011 to current year
        function buildYearCheckboxes() {
            const currentYear = new Date().getFullYear();
            const years = [];
            for (let y = 2011; y <= currentYear; y++) years.push(y);

            const sel = document.getElementById('yearSelectFilter');
            if (!sel) return;

            sel.innerHTML = `<option value="">All Years</option>` +
                years.map(y => `<option value="${y}">${y}</option>`).join('');
        }

        function applyYearFilters() {
            const typeFilter = document.getElementById('yearFilterType')?.value || '';
            const yearFilter = document.getElementById('yearSelectFilter')?.value || '';

            let filtered = cachedData.filter(d => {
                if (!d.fromdate) return false;
                const year = new Date(d.fromdate).getFullYear();
                if (isNaN(year)) return false;
                if (yearFilter && year !== parseInt(yearFilter)) return false;
                const ft = (d.formType || 'inbound').toLowerCase();
                if (typeFilter && ft !== typeFilter) return false;
                return true;
            });

            renderYearChart(filtered);
            renderYearTypeChart(filtered);
        }

        // Chart 3: Students by Destination Country (Pie Chart)
        function renderYearChart(data) {
            if (!data) data = cachedData;
            if (yearChart) yearChart.destroy();

            // Count students per destination country
            const countryCounts = {};
            data.forEach(d => {
                if (d.country) {
                    countryCounts[d.country] = (countryCounts[d.country] || 0) + 1;
                }
            });

            const countries = Object.keys(countryCounts).sort();
            const counts = countries.map(c => countryCounts[c]);
            const total = counts.reduce((a, b) => a + b, 0);

            const pieColors = [
                'rgba(239,68,68,0.88)',   // Red
                'rgba(59,130,246,0.88)',   // Blue
                'rgba(16,185,129,0.88)',   // Green
                'rgba(139,92,246,0.88)',   // Purple
                'rgba(245,158,11,0.88)',   // Amber
                'rgba(6,182,212,0.88)',    // Cyan
                'rgba(236,72,153,0.88)',   // Pink
                'rgba(20,184,166,0.88)',   // Teal
                'rgba(249,115,22,0.88)',   // Orange
                'rgba(99,102,241,0.88)',   // Indigo
                'rgba(132,204,22,0.88)',   // Lime
                'rgba(234,179,8,0.88)',    // Yellow
            ];

            const ctx = document.getElementById('yearChart').getContext('2d');

            yearChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: countries,
                    datasets: [{
                        data: counts,
                        backgroundColor: countries.map((_, i) => pieColors[i % pieColors.length]),
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        hoverBorderColor: '#000000',
                        hoverBorderWidth: 2,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '50%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#1f2937',
                                font: { size: 11, weight: '600', family: "'Poppins', sans-serif" },
                                padding: 10,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                generateLabels: (chart) => {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label} (${data.datasets[0].data[i]})`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: '#fff',
                                        lineWidth: 1,
                                        pointStyle: 'circle',
                                        index: i
                                    }));
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.85)',
                            titleFont: { size: 14, weight: '700', family: "'Poppins', sans-serif" },
                            bodyFont: { size: 13, family: "'Poppins', sans-serif" },
                            padding: 12, cornerRadius: 8,
                            callbacks: {
                                label: c => {
                                    const val = c.parsed;
                                    const pct = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                                    return ` ${val} student${val !== 1 ? 's' : ''} (${pct}%)`;
                                }
                            }
                        }
                    },
                    animation: { duration: 1000, easing: 'easeInOutQuart' }
                }
            });
        }

        // Chart 4: Students by year — Inbound vs Outbound count
        function renderYearTypeChart(data) {
            if (!data) data = cachedData;
            if (yearTypeChart) yearTypeChart.destroy();

            const yearData = {};
            data.forEach(d => {
                if (d.fromdate) {
                    const year = new Date(d.fromdate).getFullYear();
                    if (!isNaN(year)) {
                        if (!yearData[year]) yearData[year] = { inbound: 0, outbound: 0 };
                        const ft = (d.formType || 'inbound').toLowerCase();
                        if (ft === 'outbound') yearData[year].outbound += 1;
                        else yearData[year].inbound += 1;
                    }
                }
            });

            const sortedYears = Object.keys(yearData).sort();
            const ctx = document.getElementById('yearTypeChart').getContext('2d');

            yearTypeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedYears,
                    datasets: [
                        { label: 'Inbound', data: sortedYears.map(y => yearData[y].inbound), backgroundColor: 'rgba(34,197,94,0.85)', borderColor: '#000000', borderWidth: 2, borderRadius: 6, borderSkipped: false },
                        { label: 'Outbound', data: sortedYears.map(y => yearData[y].outbound), backgroundColor: 'rgba(59,130,246,0.85)', borderColor: '#000000', borderWidth: 2, borderRadius: 6, borderSkipped: false }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#1f2937', font: { size: 13, weight: '600', family: "'Poppins', sans-serif" }, padding: 16, usePointStyle: true, pointStyle: 'circle' } },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleFont: { size: 14, weight: '600', family: "'Poppins', sans-serif" },
                            bodyFont: { size: 13, family: "'Poppins', sans-serif" },
                            padding: 12, cornerRadius: 8,
                            callbacks: { label: c => ` ${c.dataset.label}: ${c.parsed.y} student${c.parsed.y !== 1 ? 's' : ''}` }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Students', color: '#6b7280', font: { size: 12, weight: '600', family: "'Poppins', sans-serif" } },
                            ticks: { color: '#1f2937', font: { size: 13, weight: '600', family: "'Poppins', sans-serif" }, padding: 8, stepSize: 1 },
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            border: { display: true, color: '#000000', width: 2 }
                        },
                        x: { ticks: { color: '#1f2937', font: { size: 13, weight: '600', family: "'Poppins', sans-serif" }, padding: 8 }, grid: { display: false }, border: { display: true, color: '#000000', width: 2 } }
                    },
                    animation: { duration: 1000, easing: 'easeInOutCubic' }
                }
            });
        }

    </script>
</body>

</html>
